{% extends "base_authenticated.html" %}
{% block title %}Edit Buy Entry{% endblock %}
{% block content %}

<!-- 🧭 Page Heading -->
<h2 class="text-2xl font-semibold mb-4 text-gray-800">
  Edit Buy Entry – {{ trade.stock_name }}
</h2>

<!-- 🔔 Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="mb-4 px-4 py-2 rounded bg-blue-100 text-blue-800 text-sm">
      {{ message }}
    </div>
  {% endfor %}
{% endwith %}

<!-- 📝 Edit Entry Form -->
<form method="POST"
      action="{{ url_for('trades.edit_entry', entry_id=entry.id) }}"
      class="max-w-md bg-white p-6 rounded shadow">

  <!-- 🔐 CSRF Protection -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- 🔢 Quantity Input -->
  <div class="mb-4">
    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
    <input type="number"
           name="quantity"
           id="quantity"
           value="{{ entry.quantity }}"
           required
           min="1"
           onwheel="this.blur()"
           oninput="validateQty(this)"
           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
  </div>

  <!-- 💰 Buy Price Input -->
  <div class="mb-4">
    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Buy Price</label>
    <input type="number"
           step="0.01"
           name="price"
           id="price"
           value="{{ entry.price }}"
           required
           min="0.01"
           onwheel="this.blur()"
           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
  </div>

  <!-- 📅 Date Picker -->
  <div class="mb-4">
    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
    <input type="date"
           name="date"
           id="date"
           value="{{ entry.date.isoformat() if entry.date else current_date }}"
           required
           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
  </div>

  <!-- 📝 Note Input -->
  <div class="mb-6">
    <label for="note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
    <textarea name="note"
              id="note"
              rows="3"
              placeholder="Add buy rationale..."
              class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">{{ entry.note }}</textarea>
  </div>

  <!-- ✅ Submit + Cancel Buttons -->
  <div class="flex gap-4">
    <button type="submit"
            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
      ✅ Update Buy Entry
    </button>
    <a href="{{ url_for('trades.view_trade', trade_id=trade.id) }}"
       class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100 transition">
      Cancel
    </a>
  </div>
</form>

<!-- 🧠 Form Logic -->
<script>
  // Set default date to today if not already set
  document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
    }
  });

  // Prevent negative or zero quantity
  function validateQty(input) {
    if (input.value < 1) {
      input.setCustomValidity("Quantity must be at least 1");
    } else {
      input.setCustomValidity("");
    }
  }
</script>

{% endblock %}
