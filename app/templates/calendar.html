{% extends 'base.html' %}
{% block content %}

<!-- ðŸ“… FullCalendar Styles & Scripts -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- ðŸ”„ View Toggle Buttons -->
<div class="flex gap-4 mb-4">
  <button id="calendarBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
    ðŸ“… Calendar View
  </button>
  <button id="listBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
    ðŸ“‹ List View
  </button>
</div>

<!-- ðŸ“Š Summary Badges -->
<div id="summary" class="flex flex-wrap gap-3 mb-6 text-sm">
  <!-- Filled dynamically via JS -->
</div>

<!-- ðŸ“… Calendar Container -->
<div id="calendar-container">
  <div id="calendar" class="bg-white p-4 rounded shadow"></div>
</div>

<!-- ðŸ“‹ List View Container -->
<div id="list-container" style="display:none;">
  <table class="min-w-full text-sm text-left text-gray-700 border border-gray-200 rounded overflow-hidden shadow">
    <thead class="bg-gray-100 text-gray-800">
      <tr>
        <th class="px-4 py-2">Date</th>
        <th class="px-4 py-2">Stock</th>
        <th class="px-4 py-2">P&L</th>
        <th class="px-4 py-2">Notes</th>
      </tr>
    </thead>
    <tbody id="trade-list" class="divide-y divide-gray-200">
      <!-- Filled dynamically via JS -->
    </tbody>
  </table>
</div>

<!-- ðŸ“œ FullCalendar Initialization -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    events: '/calendar/events',

    // Customize event display
    eventContent: function(arg) {
      return {
        html: `<div class="fc-event-title">${arg.event.title}</div>`
      };
    },

    // Tooltip for notes
    eventDidMount: function(info) {
      const notes = info.event.extendedProps.notes;
      if (notes) {
        new bootstrap.Tooltip(info.el, {
          title: notes,
          placement: 'top',
          trigger: 'hover',
          container: 'body'
        });
      }
    }
  });

  calendar.render();

  // ðŸ“Š Summary Badges
  fetch('/calendar/summary')
    .then(res => res.json())
    .then(data => {
      const summary = document.getElementById('summary');
      summary.innerHTML = `
        <span class="px-3 py-1 bg-green-100 text-green-800 rounded">This Month: â‚¹${data.this_month}</span>
        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded">Last 3 Months: â‚¹${data.last_3_months}</span>
        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded">Quarter: â‚¹${data.quarter}</span>
        <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded">Year: â‚¹${data.year}</span>
      `;
    });

  // ðŸ“‹ List View Table
  fetch('/calendar/events')
    .then(res => res.json())
    .then(events => {
      const list = document.getElementById('trade-list');
      list.innerHTML = '';
      events.forEach(ev => {
        const pnl = parseFloat(ev.title.split('â‚¹')[1]);
        const color = pnl > 0 ? 'text-green-600' : pnl < 0 ? 'text-red-600' : 'text-yellow-600';
        list.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">${ev.start}</td>
            <td class="px-4 py-2">${ev.title.split(' â‚¹')[0]}</td>
            <td class="px-4 py-2 ${color} font-semibold">â‚¹${pnl}</td>
            <td class="px-4 py-2">${ev.extendedProps.notes || 'â€”'}</td>
          </tr>
        `;
      });
    });

  // ðŸ”„ Toggle View Buttons
  document.getElementById('calendarBtn').onclick = () => {
    document.getElementById('calendar-container').style.display = 'block';
    document.getElementById('list-container').style.display = 'none';
  };
  document.getElementById('listBtn').onclick = () => {
    document.getElementById('calendar-container').style.display = 'none';
    document.getElementById('list-container').style.display = 'block';
  };
});
</script>

<!-- ðŸŽ¨ Custom Styles -->
<style>
#calendar {
  border-radius: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.fc-event-title {
  font-weight: bold;
  font-size: 0.85em;
  color: white;
  padding: 2px 4px;
  border-radius: 4px;
  background-color: inherit;
}
</style>

{% endblock %}
