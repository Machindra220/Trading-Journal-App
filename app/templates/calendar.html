{% extends "base_authenticated.html" %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <button id="prevMonth" class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">← Prev</button>
    <h2 id="monthLabel" class="text-xl font-semibold text-gray-800"></h2>
    <button id="nextMonth" class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next →</button>
  </div>

  <div class="grid grid-cols-7 gap-px bg-gray-300 text-center text-sm font-medium text-gray-700">
    <div class="bg-white py-2">Sun</div>
    <div class="bg-white py-2">Mon</div>
    <div class="bg-white py-2">Tue</div>
    <div class="bg-white py-2">Wed</div>
    <div class="bg-white py-2">Thu</div>
    <div class="bg-white py-2">Fri</div>
    <div class="bg-white py-2">Sat</div>
  </div>

  <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-300 mt-px"></div>
</div>

<script>
const calendarGrid = document.getElementById("calendarGrid");
const monthLabel = document.getElementById("monthLabel");
let currentMonth = {{ month }};
let currentYear = {{ year }};

function renderCalendar(month, year, pnlMap) {
  const firstDay = new Date(year, month - 1, 1);
  const lastDay = new Date(year, month, 0);
  const startDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();

  calendarGrid.innerHTML = "";

  // Fill blank days before the 1st
  for (let i = 0; i < startDay; i++) {
    calendarGrid.innerHTML += `<div class="bg-white h-24"></div>`;
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const pnl = pnlMap[dateStr] || 0;
    const bg = pnl > 0 ? "bg-green-100" : pnl < 0 ? "bg-red-100" : "bg-white";
    const text = pnl > 0 ? "text-green-800" : pnl < 0 ? "text-red-800" : "text-gray-800";

    calendarGrid.innerHTML += `
      <div class="${bg} h-24 p-2 text-left text-xs ${text} flex flex-col justify-between">
        <div class="font-semibold">${day}</div>
        ${pnl !== 0 ? `<div class="text-sm font-medium">₹${pnl.toFixed(2)}</div>` : ""}
      </div>
    `;
  }

  const monthName = new Date(year, month - 1).toLocaleString("default", { month: "long" });
  monthLabel.textContent = `${monthName} ${year}`;
}

function fetchAndRender() {
  fetch(`/calendar/events`)
    .then(res => res.json())
    .then(pnlMap => renderCalendar(currentMonth, currentYear, pnlMap));
}

document.getElementById("prevMonth").onclick = () => {
  currentMonth--;
  if (currentMonth < 1) {
    currentMonth = 12;
    currentYear--;
  }
  window.location.href = `/calendar?month=${currentMonth}&year=${currentYear}`;
};

document.getElementById("nextMonth").onclick = () => {
  currentMonth++;
  if (currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  }
  window.location.href = `/calendar?month=${currentMonth}&year=${currentYear}`;
};

fetchAndRender();
</script>
{% endblock %}
