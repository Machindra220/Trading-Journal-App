{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/resources.css') }}">

<h2>üß∞ Helpful Resources</h2>

<!-- ‚úÖ Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="flash-{{ category }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ‚ûï Add Resource Button -->
<button onclick="openAddModal()" class="button primary" style="background-color: #0172ad;">‚ûï Add Resource</button>

<hr>

<!-- üìã Resources Table -->
<table class="table compact-table">
  <thead>
    <tr>
      <th>Title</th>
      <th>Category</th>
      <th>Note</th>
      <th>Pinned</th>
      <th>Last Accessed</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in resources %}
    <tr>
      <td>
        <img src="https://www.google.com/s2/favicons?domain={{ r.url }}" class="favicon">
        <a href="{{ url_for('resources.access_resource', id=r.id) }}"
          target="_blank"
          rel="noopener noreferrer"
          title="Access {{ r.title }} and update last used time">
          {{ r.title }}
        </a>
      </td>
      <td>{{ r.category }}</td>
      <td>{{ r.note }}</td>
      <td>{{ 'üìå' if r.pinned else '' }}</td>
      <td>{{ r.last_accessed.strftime('%d-%m-%Y') if r.last_accessed else '‚Äî' }}</td> <!-- date format - '%d-%m-%Y %H:%M'-->
        <td style="white-space: nowrap;">
          <div style="display: inline-flex; gap: 6px; align-items: center;">
            <button type="button"
                    class="btn btn-sm btn-outline-primary"
                    onclick="openEditModal({{ r.id }}, '{{ r.title }}', '{{ r.url }}', '{{ r.category }}', `{{ r.note|escape }}`, {{ 'true' if r.pinned else 'false' }})"
                    style="background-color:#0172ad; color:white; padding:4px 10px; border-radius:4px; text-decoration:none; margin-right:4px;">
              ‚úèÔ∏è
            </button>

            <form method="POST" action="{{ url_for('resources.delete_resource', id=r.id) }}" style="margin: 0;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Delete this resource?')"
                      style="background-color:#bd5656; color:white; padding:4px 10px; border-radius:4px; text-decoration:none; margin-right:4px;">
                üóëÔ∏è
              </button>
            </form>
          </div>
        </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ‚úèÔ∏è Add/Edit Modal -->
<div id="resource-modal" class="modal">
  <form method="POST" id="resource-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input name="title" id="modal-title" placeholder="Title" required>
    <input name="url" id="modal-url" placeholder="URL" required>

    <label>Category</label>
    <select name="category" id="modal-category">
      <option value="">-- Select Existing --</option>
      {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
      {% endfor %}
    </select>

    <label>Or Add New Category</label>
    <input name="new_category" id="modal-new-category" placeholder="New Category">

    <textarea name="note" id="modal-note" placeholder="Note"></textarea>
    <label><input type="checkbox" name="pinned" id="modal-pinned"> üìå Pin</label>

    <div class="modal-actions">
      <button type="submit">üíæ Save</button>
      <button type="button" onclick="closeModal()">‚ùå Cancel</button>
    </div>
  </form>
</div>

<script>
function openAddModal() {
  const form = document.getElementById('resource-form');
  form.action = "{{ url_for('resources.add_resource') }}";
  form.reset();
  document.getElementById('resource-modal').style.display = 'block';
}

function openEditModal(id, title, url, category, note, pinned) {
  const form = document.getElementById('resource-form');
  form.action = `/resources/edit/${id}`;
  document.getElementById('modal-title').value = title;
  document.getElementById('modal-url').value = url;
  document.getElementById('modal-category').value = category;
  document.getElementById('modal-note').value = note;
  document.getElementById('modal-pinned').checked = pinned;
  document.getElementById('resource-modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('resource-modal').style.display = 'none';
}
</script>
{% endblock %}
