{% extends "base.html" %}
{% block title %}📈 Watchlist – Future Trade Opportunities{% endblock %}
{% block content %}
<h2>📈 Watchlist – Future Trade Opportunities</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="flash-{{ category }}">{{ message }}</div>
  {% endfor %}
{% endwith %}

<form method="POST" action="{{ url_for('watchlist.add') }}" class="mb-4">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="row g-3">
    <div class="col-md-3">
      <label for="stock_name">Stock Name</label>
      <input type="text" name="stock_name" id="stock_name" class="form-control" required />
    </div>

    <div class="col-md-2">
      <label for="target_price">Target Price</label>
      <input type="number" step="0.01" name="target_price" id="target_price" class="form-control" required min="0.01" onwheel="this.blur()" />
    </div>

    <div class="col-md-2">
      <label for="stop_loss">Stop Loss</label>
      <input type="number" step="0.01" name="stop_loss" id="stop_loss" class="form-control" required min="0.01" onwheel="this.blur()" />
    </div>

    <div class="col-md-2">
      <label for="expected_move">Expected Move</label>
      <input type="number" step="0.01" name="expected_move" id="expected_move" class="form-control" required min="0.01" onwheel="this.blur()" />
    </div>

    <div class="col-md-3">
      <label for="setup_type">Setup Type</label>
      <select name="setup_type" id="setup_type" class="form-select" required>
        <option value="">Select</option>
        <option value="Breakout">Breakout</option>
        <option value="Pullback">Pullback</option>
        <option value="Reversal">Reversal</option>
        <option value="News Driven">News Driven</option>
      </select>
    </div>

    <div class="col-md-2">
      <label for="confidence">Confidence</label>
      <select name="confidence" id="confidence" class="form-select">
        <option value="">Select</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
    </div>

    <div class="col-md-3">
      <label for="date_added">Date Added</label>
      <input type="date" name="date_added" id="date_added" class="form-control" required />
    </div>

    <div class="col-md-7">
      <label for="notes">Notes</label>
      <textarea name="notes" id="notes" rows="2" class="form-control" placeholder="Catalyst, earnings, macro context..."></textarea>
    </div>
  </div>

  <div class="mt-3">
    <button type="submit" class="btn btn-success">➕ Add to Watchlist</button>
  </div>
</form>

<hr>

<h4>📋 Current Watchlist</h4>
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>Stock</th>
      <th>Target</th>
      <th>SL</th>
      <th>Move</th>
      <th>Setup</th>
      <th>Confidence</th>
      <th>Date</th>
      <th>Status</th>
      <th>Notes</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for item in watchlist %}
    <tr>
      <td>{{ item.stock_name }}</td>
      <td>₹{{ item.target_price }}</td>
      <td>₹{{ item.stop_loss }}</td>
      <td>₹{{ item.expected_move }}</td>
      <td>{{ item.setup_type }}</td>
      <td>{{ item.confidence }}</td>
      <td>{{ item.date_added.strftime('%Y-%m-%d') }}</td>
      <td>{{ item.status }}</td>
      <td>{{ item.notes }}</td>
      <!-- <td>
        <a href="{{ url_for('watchlist.edit', item_id=item.id) }}" class="btn btn-sm btn-primary">✏️ Edit</a>
        <a href="{{ url_for('watchlist.delete', item_id=item.id) }}" class="btn btn-sm btn-danger">🗑️ Delete</a>
      </td> -->
      <td>
        <a href="{{ url_for('watchlist.edit', item_id=item.id) }}" class="btn btn-sm btn-primary">✏️ Edit</a>
        <form method="POST" action="{{ url_for('watchlist.delete', item_id=item.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this item?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-danger">🗑️ Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="10" class="text-center">No watchlist items yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date_added');
    if (!dateInput.value) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
    }
  });
</script>
{% endblock %}
