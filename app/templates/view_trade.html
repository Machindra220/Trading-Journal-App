{% extends "base.html" %}
{% block title %}Trade Details{% endblock %}
{% block content %}
<h2>{{ trade.stock_name }} ‚Äì Trade Details</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="flash-{{ category }}">{{ message }}</div>
  {% endfor %}
{% endwith %}

<p>
  <strong>Status:</strong> {{ status }} |
  <strong>P&L:</strong>
{% if pnl is not none %}
  {% if pnl >= 0 %}
    <span style="color:green;">‚Çπ{{ pnl }}</span>
  {% else %}
    <span style="color:red;">‚Çπ{{ pnl }}</span>
  {% endif %}
{% else %}
  <span style="color:gray;">‚Äî</span>
{% endif %}

  |
  {% if status == "Open" %}
    <strong>Running for:</strong> {{ duration_days }} days
  {% else %}
    <strong>Completed in:</strong> {{ duration_days }} days
  {% endif %}
</p>

{% if trade.note %}
  <p><strong>Note:</strong> {{ trade.note }}</p>
{% endif %}

<hr />

<h3>Buy Entry</h3>
<fieldset>
  <!-- <legend>Buy Entry</legend> -->
<form method="POST" action="{{ url_for('trades.add_entry', trade_id=trade.id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">  <!-- CSRF Token -->
  <label for="buy_quantity">Quantity</label>
  <input type="number" name="quantity" id="buy_quantity" required />

  <label for="buy_price">Buy Price</label>
  <input type="number" step="0.01" name="price" id="buy_price" required />

  <label for="buy_date">Date</label>
  <input type="date" name="date" id="buy_date" required />

  <label for="buy_note">Note</label>
  <textarea name="note" id="buy_note" rows="2" placeholder="Add buy rationale or context..."></textarea>

  <button type="submit">üü¢ Add Buy</button>
</form>
</fieldset>

<h3>Sell Exit</h3>
<fieldset>
  <!-- <legend>Sell Exit</legend> -->
<form method="POST" action="{{ url_for('trades.add_exit', trade_id=trade.id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">  <!-- CSRF Token -->
  <label for="sell_quantity">Quantity</label>
  <input type="number" name="quantity" id="sell_quantity" required />

  <label for="sell_price">Sell Price</label>
  <input type="number" step="0.01" name="price" id="sell_price" required />

  <label for="sell_date">Date</label>
  <input type="date" name="date" id="sell_date" required />

  <label for="sell_note">Note</label>
  <textarea name="note" id="sell_note" rows="2" placeholder="Add exit rationale or outcome..."></textarea>

  <button type="submit">üî¥ Add Sell</button>
</form>
</fieldset>

<hr />
<!-- Buy History Actions -->
<h3>Buy History</h3>
{% if entries %}
  <table style="width: 100%; table-layout: auto;">
    <thead>
      <tr><th>Date</th><th>Qty</th><th>Price</th><th>Invested</th><th>Note</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for e in entries %}
        <tr>
          <td>{{ e.date.strftime('%d %b %Y') }}</td>
          <td>{{ e.quantity }}</td>
          <td>‚Çπ{{ e.price }}</td>
          <td>‚Çπ{{ e.invested_amount }}</td>
          <td>{{ e.note or '‚Äî' }}</td>
          <td style="white-space: nowrap; vertical-align: middle;">
            <div style="display: inline-flex; gap: 6px; align-items: center;">
              <!-- Edit Entry -->
              <form method="GET" action="{{ url_for('trades.edit_entry', entry_id=e.id) }}" style="margin:0;">
                <button type="submit"
                        class="btn btn-sm btn-outline-primary"
                        title="Edit Entry"
                        style="background-color:#0172ad; color:white; padding:4px 10px; border-radius:4px;">
                  ‚úèÔ∏è
                </button>
              </form>

              <!-- Delete Entry -->
              <form method="POST" action="{{ url_for('trades.delete_entry', entry_id=e.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this entry?')"
                        title="Delete Entry"
                        style="background-color:#bd5656; color:white; padding:4px 10px; border-radius:4px;">
                  üóëÔ∏è
                </button>
              </form>
            </div>
          </td>


        </tr>

      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No buy entries yet.</p>
{% endif %}

<!-- Sell History Actions -->
<h3>Sell History</h3>
{% if exits %}
  <table style="width: 100%; table-layout: auto;">
    <thead>
      <tr><th>Date</th><th>Qty</th><th>Price</th><th>Exited</th><th>Note</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for x in exits %}
        <tr>
          <td>{{ x.date.strftime('%d %b %Y') }}</td>
          <td>{{ x.quantity }}</td>
          <td>‚Çπ{{ x.price }}</td>
          <td>‚Çπ{{ x.exit_amount }}</td>
          <td>{{ x.note or '‚Äî' }}</td>
          <td style="white-space: nowrap; vertical-align: middle;">
            <div style="display: inline-flex; gap: 6px; align-items: center;">
              <!-- Edit Exit -->
              <form method="GET" action="{{ url_for('trades.edit_exit', exit_id=x.id) }}" style="margin:0;">
                <button type="submit"
                        class="btn btn-sm btn-outline-primary"
                        title="Edit Exit"
                        style="background-color:#0172ad; color:white; padding:4px 10px; border-radius:4px;">
                  ‚úèÔ∏è
                </button>
              </form>

              <!-- Delete Exit -->
              <form method="POST" action="{{ url_for('trades.delete_exit', exit_id=x.id) }}" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this exit?')"
                        title="Delete Exit"
                        style="background-color:#bd5656; color:white; padding:4px 10px; border-radius:4px;">
                  üóëÔ∏è
                </button>
              </form>
            </div>
          </td>

        </tr>

      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No sell exits yet.</p>
{% endif %}

<!-- Delete Confirmation Modal Template -->
<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;">
  <div id="modal-box" style="background:white; padding:20px; border-radius:8px; width:300px; margin:100px auto; text-align:center;">
    <p id="modal-message">Are you sure you want to delete this item?</p>
    <form id="modal-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" style="background-color:#dc3545; color:white; padding:6px 12px; border:none; border-radius:4px;">Yes, Delete</button>
      <button type="button" onclick="closeModal()" style="margin-left:10px; padding:2px 12px;">Cancel</button>
    </form>
  </div>
</div>

<script>
function openModal(id) {
  const form = document.getElementById('modal-form');
  const overlay = document.getElementById('modal-overlay');
  const message = document.getElementById('modal-message');

  if (id.startsWith('entry-')) {
    const entryId = id.split('-')[1];
    form.action = "{{ url_for('trades.delete_entry', entry_id=0) }}".replace('/0', `/${entryId}`);
    message.textContent = "Delete this buy entry?";
  } else if (id.startsWith('exit-')) {
    const exitId = id.split('-')[1];
    form.action = "{{ url_for('trades.delete_exit', exit_id=0) }}".replace('/0', `/${exitId}`);
    message.textContent = "Delete this sell exit?";
  }

  overlay.style.display = 'block';
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}
</script>

{% endblock %}