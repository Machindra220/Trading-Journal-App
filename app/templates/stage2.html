{% extends "base_authenticated.html" %}
{% block content %}
<h2 class="text-xl font-semibold mb-2">ðŸ“ˆ Stage 2 Stocks</h2>

{% if error %}
  <p class="text-red-600 bg-red-100 border border-red-300 rounded px-4 py-2 mb-4">
    {{ error }}
  </p>
{% else %}
{% if summary_message %}
  <p class="text-green-700 bg-green-100 border border-green-300 rounded px-4 py-2 mb-4">
    {{ summary_message }}
  </p>
{% endif %}

  <p class="text-sm text-gray-600 mb-4">Last processed: {{ last_processed_time }}</p>
  <p class="text-sm text-gray-600 mb-1">Source: {{ source_name }}</p>

  {% if stocks %}
  <table class="min-w-full bg-white rounded shadow">
    <thead class="bg-blue-100 text-left">
      <tr>
        <th class="px-4 py-2">#</th>
        <th class="px-4 py-2">Symbol</th>
        <th class="px-4 py-2">Price</th>
        <th class="px-4 py-2">30W MA</th>
        <th onclick="toggleSort('volume')" data-sort="desc">Volume â–²</th>
        <th onclick="toggleSort('vol_avg')" data-sort="desc">Avg Volume â–²</th>
        <th class="px-4 py-2">Rel Strength</th>
        <th class="px-4 py-2">Persistence</th>
        <th class="px-4 py-2">Tag</th>
      </tr>
    </thead>
    <tbody>
      {% for stock in stocks %}
      <tr class="border-t">
        <td class="px-4 py-2">{{ stock.rank }}</td>
        <td class="px-4 py-2 flex items-center gap-2">
          <span>{{ stock.symbol_clean }}</span>
          <button onclick="copyToClipboard('{{ stock.symbol_clean }}')" class="text-blue-600 hover:underline text-sm">ðŸ“‹ Copy</button>
        </td>
        <td class="px-4 py-2">{{ stock.price }}</td>
        <td class="px-4 py-2">{{ stock.ma_30w }}</td>
        <td class="px-4 py-2" data-key="volume">{{ stock.volume }}</td>
        <td class="px-4 py-2" data-key="vol_avg">{{ stock.vol_avg }}</td>
        <td class="px-4 py-2" data-key="rs">{{ stock.rs }}</td>
        <td class="px-4 py-2" data-key="days_present">{{ stock.persistence.split()[0] }}</td>
        <td class="px-4 py-2">{{ stock.tag }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p class="text-yellow-600 bg-yellow-100 border border-yellow-300 rounded px-4 py-2 mt-4">
      No stocks matched Stage 2 criteria today.
    </p>
  {% endif %}
{% endif %}
<!-- 
<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert(`Copied: ${text}`);
  });
}

function sortTable(key) {
  const rows = Array.from(document.querySelectorAll("tbody tr"));
  rows.sort((a, b) => {
    const valA = parseFloat(a.querySelector(`[data-key="${key}"]`).textContent) || 0;
    const valB = parseFloat(b.querySelector(`[data-key="${key}"]`).textContent) || 0;
    return valB - valA; // descending
  });
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  rows.forEach(row => tbody.appendChild(row));
}
</script> -->
{% endblock %}
