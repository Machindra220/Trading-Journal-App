{% extends "base.html" %}
{% block title %}Past/Completed Trades{% endblock %}
{% block content %}
<h2>ğŸ“Š Past/Completed Trades</h2>

<!-- Filter Row -->
<form method="GET" action="{{ url_for('trades.trade_history') }}" style="margin-bottom:20px;">
  <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:flex-end;">

    <div>
      <label for="stock_filter" title="Filter trades by stock symbol">ğŸ“ˆ Stock</label>
      <select name="stock" id="stock_filter">
        <option value="">All</option>
        {% for symbol in stock_list %}
          <option value="{{ symbol }}" {% if symbol == selected_stock %}selected{% endif %}>{{ symbol }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="date_range" title="Show trades closed in a specific time window">ğŸ“… Date Range</label>
      <select name="date_range" id="date_range">
        <option value="">All</option>
        <option value="last_month" {% if selected_range == 'last_month' %}selected{% endif %}>Last Month</option>
        <option value="last_3_months" {% if selected_range == 'last_3_months' %}selected{% endif %}>Last 3 Months</option>
        <option value="last_year" {% if selected_range == 'last_year' %}selected{% endif %}>Last Year</option>
      </select>
    </div>

    <div>
      <label for="sort" title="Sort trades by realized profit/loss">ğŸ”ƒ Sort</label>
      <select name="sort" id="sort">
        <option value="desc" {% if sort == 'desc' %}selected{% endif %}>High Profit â†’ Low</option>
        <option value="asc" {% if sort == 'asc' %}selected{% endif %}>Low Profit â†’ High</option>
      </select>
    </div>

    <div style="display: inline-flex; gap: 10px; margin-top: 1.5em; align-items: center;">
      <button type="submit" title="Apply selected filters" style="padding: 6px 16px; font-size: 0.9rem; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” Apply</button>
      <a href="{{ url_for('trades.export_history', stock=selected_stock, date_range=selected_range, sort=sort) }}"
         class="button" title="Download filtered trades as Excel"
         style="padding: 6px 16px; font-size: 0.9rem; background-color: #17a2b8; color: white; border-radius: 4px; text-decoration: none; display: inline-block;">ğŸ“¤ Export</a>
           <button onclick="window.print()" title="Print or Save as PDF" class="button" style="padding: 6px 16px; font-size: 0.9rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ–¨ï¸ Print PDF
      </button> <!-- style="display: inline-flex; gap: 6px; align-items: center;" text-decoration:none; background:#6c757d; color:white; -->
    </div>

  </div>
</form>


<!-- Trade Table -->
{% if trades %}
  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Stock Name</th>
          <th>Entry</th>
          <th>Exit</th>
          <th>Entry (Avg)</th>
          <th>Exit (Avg)</th>
          <th>Quantity</th>
          <th>Duration</th>
          <th>Realized P&L</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in trades %}
          <tr>
            <td>{{ t.stock_name }}</td>
            <td>{{ t.entry_date.strftime('%d %b %Y') if t.entry_date else 'â€”' }}</td>
            <td>{{ t.exit_date.strftime('%d %b %Y') if t.exit_date else 'â€”' }}</td>
            <td>â‚¹{{ "%.2f"|format(t.avg_entry_price) }}</td>
            <td>â‚¹{{ "%.2f"|format(t.avg_exit_price) }}</td>
            <td>{{ t.total_quantity }}</td>
            <td>{{ t.total_days }} days</td>
            <td>
              {% if t.realized_pnl >= 0 %}
                <span style="color:green;">â‚¹{{ "%.2f"|format(t.realized_pnl) }}</span>
              {% else %}
                <span style="color:red;">â‚¹{{ "%.2f"|format(t.realized_pnl) }}</span>
              {% endif %}
            </td>
            <td>{{ t.notes or 'â€”' }}</td>
            <td style="white-space: nowrap;">
              <div style="display: inline-flex; gap: 6px; align-items: center;">
                <!-- View -->
                <form method="GET" action="{{ url_for('trades.view_trade', trade_id=t['id']) }}" style="margin:0;">
                  <button type="submit"
                          class="btn btn-sm btn-outline-info"
                          title="View Trade"
                          style="padding: 4px 8px;">
                    ğŸ”
                  </button>
                </form>

                <!-- Edit disabled on history page -->
                <!-- <a href="{{ url_for('trades.edit_trade', trade_id=t['id']) }}"
                  class="btn btn-sm btn-outline-primary" title="Edit">
                  âœï¸
                </a> -->

                <!-- Delete -->
                <form method="POST" action="{{ url_for('trades.delete_trade', trade_id=t['id']) }}" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Delete this trade?')"
                          title="Delete"
                          style="background-color:#bd5656; padding: 4px 8px; font-size: 0.875rem; line-height: 1.2;">
                    ğŸ—‘ï¸
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div style="color:gray; font-style:italic;">No completed trades found for selected filters.</div>
{% endif %}
{% endblock %}
