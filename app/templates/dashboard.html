{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h2>My Trades</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="flash-{{ category }}">{{ message }}</div>
  {% endfor %}
{% endwith %}

<a href="{{ url_for('trades.add_trade') }}" role="button">➕ Add New Trade</a>

{% if trades %}
  <table>
    <thead>
      <tr>
        <th>Stock</th>
        <th>Status</th>
        <th>Invested</th>
        <th>Exited</th>
        <th>P&L</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for trade in trades %}
        <tr>
          <td>{{ trade.stock_name }}</td>

          <td>
            {% if trade.status == "Closed" %}
              <span style="background-color:#dc3545; color:white; padding:2px 6px; border-radius:4px;">Closed</span>
            {% else %}
              <span style="background-color:#28a745; color:white; padding:2px 6px; border-radius:4px;">Open</span>
            {% endif %}
          </td>

          <td>₹{{ trade.total_invested }}</td>
          <td>₹{{ trade.total_exited }}</td>

          <td>
            {% if trade.pnl is not none %}
              {% if trade.pnl >= 0 %}
                <span style="color:green;">₹{{ trade.pnl }}</span>
              {% else %}
                <span style="color:red;">₹{{ trade.pnl }}</span>
              {% endif %}
            {% else %}
              <span style="color:gray;">—</span>
            {% endif %}
          </td>
<td style="white-space: nowrap;">
  <div style="display: inline-flex; gap: 6px; align-items: center;">
    <a href="{{ url_for('trades.view_trade', trade_id=trade.id) }}"
       class="btn btn-sm btn-outline-secondary" title="View">
      🔍
    </a>

    <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
       class="btn btn-sm btn-outline-primary" title="Edit">
      ✏️
    </a>

    <form method="POST" action="{{ url_for('trades.delete_trade', trade_id=trade.id) }}" style="margin:0;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit"
              class="btn btn-sm btn-outline-danger"
              onclick="return confirm('Delete this trade?')"
              title="Delete">
        🗑️
      </button>
    </form>
  </div>
</td>


        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No trades yet. Start by adding one!</p>
{% endif %}

<div id="trade-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;">
  <div style="background:white; padding:20px; border-radius:8px; width:300px; margin:100px auto; text-align:center;">
    <p>Are you sure you want to delete this trade?</p>
    <form id="trade-modal-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" style="background-color:#dc3545; color:white; padding:6px 12px; border:none; border-radius:4px;">Yes, Delete</button>
      <button type="button" onclick="closeTradeModal()" style="margin-left:10px; padding:6px 12px;">Cancel</button>
    </form>
  </div>
</div>

<script>
function openTradeModal(button) {
  const form = document.getElementById('trade-modal-form');
  const overlay = document.getElementById('trade-modal-overlay');
  const deleteUrl = button.getAttribute('data-delete-url');

  form.action = deleteUrl;
  overlay.style.display = 'block';
}
</script>


{% endblock %}
