{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h2>My Trades <span style="font-size:1rem; color:#555;">‚Äî Total Invested: ‚Çπ{{ total_invested }}</span></h2>


{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="flash-{{ category }}">{{ message }}</div>
  {% endfor %}
{% endwith %}

<a href="{{ url_for('trades.add_trade') }}" role="button">‚ûï Add New Trade</a>

{% if trades %}
  <table>
    <thead>
      <tr>
        <th>Stock</th>
        <th>Status</th>
        <th>Avg Price</th>
        <th>Qty</th>
        <th>Exited Qty</th>
        <th>Invested</th>
        <th>Realized PnL</th>
        <th>Entry Date</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
      <tbody>
        {% for trade in trades %}
          <tr>
            <td>{{ trade.stock_name }}</td>

            <td>
              {% if trade.status == "Closed" %}
                <span style="background-color:#dc3545; color:white; padding:2px 6px; border-radius:4px;">Closed</span>
              {% elif trade.quantity < trade.exited_quantity and trade.quantity > 0 %}
                <span style="background-color:#ffc107; color:black; padding:2px 6px; border-radius:4px;">Partial Exit</span>
              {% else %}
                <span style="background-color:#28a745; color:white; padding:2px 6px; border-radius:4px;">Open</span>
              {% endif %}
            </td>

            <td>{{ trade.avg_entry_price }}</td>
            <td>{{ trade.quantity }}</td>
            <td>{{ trade.exited_quantity }}</td>
            <td>‚Çπ{{ trade.total_invested }}</td>
            <td>‚Çπ{{ trade.realized_pnl }}</td>
            <td>{{ trade.entry_date }}</td>
            <td>{{ trade.note }}</td>
            

            <td style="white-space: nowrap; vertical-align: middle;">
              <div style="display: inline-flex; gap: 6px; align-items: center;">
                <!-- View -->
                <form method="GET" action="{{ url_for('trades.view_trade', trade_id=trade.id) }}" style="margin:0;">
                  <button type="submit"
                          class="btn btn-sm btn-outline-secondary"
                          title="View Trade"
                          style="background-color:#6c757d; color:white; padding:4px 10px; border-radius:4px;">
                    üîç
                  </button>
                </form>

                <!-- Edit -->
                <form method="GET" action="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" style="margin:0;">
                  <button type="submit"
                          class="btn btn-sm btn-outline-primary"
                          title="Edit Trade"
                          style="background-color:#0172ad; color:white; padding:4px 10px; border-radius:4px;">
                    ‚úèÔ∏è
                  </button>
                </form>

                <!-- Delete -->
                <form method="POST" action="{{ url_for('trades.delete_trade', trade_id=trade.id) }}" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Delete this trade?')"
                          title="Delete Trade"
                          style="background-color:#bd5656; color:white; padding:4px 10px; border-radius:4px;">
                    üóëÔ∏è
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>

  </table>
{% else %}
  <p>No trades yet. Start by adding one!</p>
{% endif %}

<div id="trade-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;">
  <div style="background:white; padding:20px; border-radius:8px; width:300px; margin:100px auto; text-align:center;">
    <p>Are you sure you want to delete this trade?</p>
    <form id="trade-modal-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" style="background-color:#dc3545; color:white; padding:6px 12px; border:none; border-radius:4px;">Yes, Delete</button>
      <button type="button" onclick="closeTradeModal()" style="margin-left:10px; padding:6px 12px;">Cancel</button>
    </form>
  </div>
</div>

<script>
function openTradeModal(button) {
  const form = document.getElementById('trade-modal-form');
  const overlay = document.getElementById('trade-modal-overlay');
  const deleteUrl = button.getAttribute('data-delete-url');

  form.action = deleteUrl;
  overlay.style.display = 'block';
}
</script>

{% endblock %}
