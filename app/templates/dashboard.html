{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<!-- üß≠ Page Heading -->
<h2 class="text-2xl font-semibold mb-4 text-gray-800">
  My Trades
  <span class="text-base text-gray-500 font-normal">‚Äî Total Invested: ‚Çπ{{ total_invested }}</span>
</h2>

<!-- üîî Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    <div class="mb-4 px-4 py-2 rounded bg-blue-100 text-blue-800 text-sm">
      {{ message }}
    </div>
  {% endfor %}
{% endwith %}

<!-- ‚ûï Add Trade Button -->
<a href="{{ url_for('trades.add_trade') }}"
   class="inline-block mb-4 px-4 py-2 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition">
  ‚ûï Add New Trade
</a>

<!-- üìä Trades Table -->
{% if trades %}
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-300 rounded shadow-sm text-sm">
      <thead class="bg-gray-300 text-gray-700">
        <tr>
          <th class="px-4 py-2 text-left">Stock</th>
          <th class="px-4 py-2 text-left">Avg Price</th>
          <th class="px-4 py-2 text-left">Qty</th>
          <th class="px-4 py-2 text-left">Exited Qty</th>
          <th class="px-4 py-2 text-left">Invested</th>
          <th class="px-4 py-2 text-left">Realized PnL</th>
          <th class="px-4 py-2 text-left">Entry Date</th>
          <th class="px-4 py-2 text-left">Note</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for trade in trades %}
        <tr class="hover:bg-gray-50">
          <!-- üìå Trade Status Badge + Stock Name -->
          <td class="px-4 py-2 whitespace-nowrap flex items-center gap-2">
            {% if trade.status == "Closed" %}
              <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">C</span>
            {% elif trade.quantity < trade.exited_quantity and trade.quantity > 0 %}
              <span class="bg-yellow-400 text-black text-xs px-2 py-1 rounded">PE</span>
            {% else %}
              <span class="bg-green-600 text-white text-xs px-2 py-1 rounded">O</span>
            {% endif %}
            {{ trade.stock_name }}
          </td>

          <!-- üí∞ Trade Details -->
          <td class="px-4 py-2">‚Çπ{{ trade.avg_entry_price }}</td>
          <td class="px-4 py-2">{{ trade.quantity }}</td>
          <td class="px-4 py-2">{{ trade.exited_quantity }}</td>
          <td class="px-4 py-2">‚Çπ{{ trade.total_invested }}</td>
          <td class="px-4 py-2">‚Çπ{{ trade.realized_pnl }}</td>
          <td class="px-4 py-2">{{ trade.entry_date }}</td>
          <td class="px-4 py-2">{{ trade.note }}</td>

          <!-- üõ†Ô∏è Action Buttons -->
          <td class="px-4 py-2 whitespace-nowrap">
            <div class="flex gap-2">
              <!-- View -->
              <form method="GET" action="{{ url_for('trades.view_trade', trade_id=trade.id) }}">
                <button type="submit"
                        class="px-2 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700"
                        title="View Trade">
                  üîç
                </button>
              </form>

              <!-- Edit -->
              <form method="GET" action="{{ url_for('trades.edit_trade', trade_id=trade.id) }}">
                <button type="submit"
                        class="px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700"
                        title="Edit Trade">
                  ‚úèÔ∏è
                </button>
              </form>

              <!-- Delete -->
              <form method="POST" action="{{ url_for('trades.delete_trade', trade_id=trade.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        onclick="return confirm('Delete this trade?')"
                        class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                        title="Delete Trade">
                  üóëÔ∏è
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <!-- üì≠ Empty State -->
  <p class="mt-4 text-gray-600">No trades yet. Start by adding one!</p>
{% endif %}

<!-- üßæ Modal (Unused but kept for future enhancement) -->
<div id="trade-modal-overlay"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow-md w-80 text-center">
    <p class="mb-4">Are you sure you want to delete this trade?</p>
    <form id="trade-modal-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Yes, Delete
      </button>
      <button type="button"
              onclick="closeTradeModal()"
              class="ml-2 px-4 py-2 border rounded">
        Cancel
      </button>
    </form>
  </div>
</div>

<!-- üß† Modal Logic -->
<script>
function openTradeModal(button) {
  const form = document.getElementById('trade-modal-form');
  const overlay = document.getElementById('trade-modal-overlay');
  const deleteUrl = button.getAttribute('data-delete-url');

  form.action = deleteUrl;
  overlay.classList.remove('hidden');
}
</script>

{% endblock %}
