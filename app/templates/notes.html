{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notes.css') }}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<h2>📝 New Day Notes</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="flash-{{ category }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<button onclick="openNoteModal()" class="button primary">➕ Add Note</button>

<hr>

<div class="notes-list">
  {% for note in notes %}
  <div class="note-card">
    <div class="note-header">
      <strong>{{ note.date }}</strong> — {{ note.summary }}
    </div>
    <div class="note-body">
      {{ note.content | safe }}
    </div>
    {% if note.images %}
    <div class="note-images">
      {% for img in note.images %}
      <div class="image-thumb">
        <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}">
        <form method="POST" action="{{ url_for('notes.delete_image', id=img.id) }}" onsubmit="return confirm('Delete image?')">
          <button type="submit">❌</button>
        </form>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    <div class="note-actions">
      <form method="POST" action="{{ url_for('notes.delete_note', id=note.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" onclick="return confirm('Delete this note?')">🗑️ Delete</button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>


<!-- Modal -->
<div id="note-modal" class="modal">
  <form method="POST" action="{{ url_for('notes.add_note') }}" enctype="multipart/form-data" onsubmit="syncEditor()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label>Date</label>
    <input type="date" name="date" value="{{ today if today else '' }}" required>


    <label>Summary</label>
    <input type="text" name="summary" required>
    <label>Notes</label>
    <div id="editor"></div>
    <input type="hidden" name="content" id="hidden-content">
    <label>Attach Images</label>
    <input type="file" name="images" multiple accept="image/*">
    <div class="modal-actions">
      <button type="submit">💾 Save</button>
      <button type="button" onclick="closeNoteModal()">❌ Cancel</button>
    </div>
  </form>
</div>

<script>
var quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Write your notes here...',
  modules: {
    toolbar: [
    [{ 'header': [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'color': [] }, { 'background': [] }],
    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
    [{ 'align': [] }],
    ['blockquote', 'code-block'],
    ['link', 'image'],
    ['clean']
    ]

  }
});


function syncEditor() {
  document.getElementById('hidden-content').value = quill.root.innerHTML;
}
function openNoteModal() {
  document.getElementById('note-modal').style.display = 'block';
}
function closeNoteModal() {
  document.getElementById('note-modal').style.display = 'none';
}
</script>
{% endblock %}
