{% extends 'base.html' %}
{% block content %}

<!-- üìù Notes Page Styles & Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- üß≠ Page Heading -->
<h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">üìù New Day Notes</h2>

<!-- üîî Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="mb-4 px-4 py-2 rounded bg-blue-100 text-blue-800 text-sm">
        {{ msg }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ‚ûï Add Note Button -->
 <div class="text-center mb-6">
<button onclick="openNoteModal()"
        class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
  ‚ûï Add Note
</button>
</div>

<hr class="my-6">

<!-- üìã Notes List -->
<div class="max-w-5xl mx-auto">
  {% for note in notes %}
  <div class="mb-6 p-4 border border-gray-200 rounded shadow-sm bg-white">
    <!-- üóìÔ∏è Note Header -->
    <div class="mb-2 text-gray-700 font-medium">
      <strong>{{ note.date }}</strong> ‚Äî {{ note.summary }}
    </div>

    <!-- üìÑ Note Content -->
    <div class="mb-2 prose max-w-none">
      {{ note.content | safe }}
    </div>

    <!-- üñºÔ∏è Note Images -->
    {% if note.images %}
    <div class="flex flex-wrap gap-4 mb-2">
      {% for img in note.images %}
      <div class="relative">
        <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}"
             class="rounded border max-w-[150px]">
        <form method="POST"
              action="{{ url_for('notes.delete_image', id=img.id) }}"
              onsubmit="return confirm('Delete image?')"
              class="absolute top-1 right-1">
          <button type="submit"
                  class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
            ‚ùå
          </button>
        </form>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- üõ†Ô∏è Note Actions -->
    <div class="flex gap-2">
      <a href="{{ url_for('notes.edit_note', id=note.id) }}"
         class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition">
        ‚úèÔ∏è Edit
      </a>
      <form method="POST" action="{{ url_for('notes.delete_note', id=note.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                onclick="return confirm('Delete this note?')"
                class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition">
          üóëÔ∏è Delete
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<!-- üßæ Note Modal -->
<div id="note-modal"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <form method="POST"
        action="{{ url_for('notes.add_note') }}"
        enctype="multipart/form-data"
        onsubmit="syncEditor()"
        class="bg-white p-6 rounded shadow-md w-full max-w-lg space-y-4">

    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- üìÖ Date -->
    <div>
      <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
      <input type="date"
             name="date"
             value="{{ today if today else '' }}"
             required
             class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>

    <!-- üìù Summary -->
    <div>
      <label for="summary" class="block text-sm font-medium text-gray-700 mb-1">Summary</label>
      <input type="text"
             name="summary"
             required
             class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>

    <!-- üßæ Quill Editor -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
      <div id="editor" class="border border-gray-300 rounded" style="height: 200px;"></div>
      <input type="hidden" name="content" id="hidden-content">
    </div>

    <!-- üìé Image Upload -->
    <div>
      <label for="images" class="block text-sm font-medium text-gray-700 mb-1">Attach Images</label>
      <input type="file"
             name="images"
             multiple
             accept="image/*"
             class="w-full px-3 py-2 border border-gray-300 rounded" />
    </div>

    <!-- ‚úÖ Modal Actions -->
    <div class="flex justify-end gap-4 pt-4">
      <button type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
        üíæ Save
      </button>
      <button type="button"
              onclick="closeNoteModal()"
              class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100 transition">
        ‚ùå Cancel
      </button>
    </div>
  </form>
</div>

<!-- üß† Quill Editor Logic -->
<script>
  var quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Write your notes here...',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'align': [] }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
      ]
    }
  });

  function syncEditor() {
    document.getElementById('hidden-content').value = quill.root.innerHTML;
  }

  function openNoteModal() {
    document.getElementById('note-modal').classList.remove('hidden');
  }

  function closeNoteModal() {
    document.getElementById('note-modal').classList.add('hidden');
  }
</script>

{% endblock %}
