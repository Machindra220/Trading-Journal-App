{% extends "base_authenticated.html" %}
{% block content %}
<div class="p-4">
  <h1 class="text-3xl font-bold mb-6 text-blue-800">üìà Top Performing Stocks</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="px-4 py-2 rounded text-sm font-medium
                      {% if category == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- CSV Upload Form -->
  <form action="{{ url_for('performers.upload_csv') }}" method="POST" enctype="multipart/form-data" class="mb-8 bg-white p-4 rounded shadow">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label class="block mb-2 font-medium text-gray-700">Upload CSV File:</label>
    <input type="file" name="csv_file" accept=".csv" required class="block w-full border border-gray-300 rounded px-3 py-2 mb-4">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Upload</button>
  </form>

  <!-- Loading Message -->
  <div id="loading" class="text-center text-blue-600 font-semibold text-lg my-8">
    üîÑ Processing stock returns... please wait.
  </div>
  <div class="mb-4 text-sm text-gray-700 flex flex-wrap gap-x-6 gap-y-2">
    <div class="flex items-center">
      <span class="inline-block w-4 h-4 bg-purple-100 mr-2 rounded"></span> In all three indices
    </div>
    <div class="flex items-center">
      <span class="inline-block w-4 h-4 bg-green-100 mr-2 rounded"></span> In Nifty 200 & BSE 200
    </div>
    <div class="flex items-center">
      <span class="inline-block w-4 h-4 bg-yellow-100 mr-2 rounded"></span> In Nifty 200 & Nifty 500
    </div>
    <div class="flex items-center">
      <span class="inline-block w-4 h-4 bg-pink-100 mr-2 rounded"></span> In BSE 200 & Nifty 500
    </div>
  </div>

<h2 class="text-xl font-semibold mb-2">üèÜ Top Performers</h2>
<p class="text-sm text-gray-600 mb-4">
  Last updated: {{ last_processed_time.strftime('%d %b %Y, %H:%M') }}
</p>

  <div id="tables" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Nifty 200 -->
      <div>
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Nifty 200 (Top 20)</h2>
        <div class="overflow-x-auto rounded shadow">
          <table class="min-w-full bg-white border border-gray-300">
            <thead class="bg-blue-100 text-blue-900">
              <tr>
                <th class="px-4 py-2">#</th>
                <th class="px-4 py-2">Stock</th>
                <th class="px-4 py-2">Start Price</th>
                <th class="px-4 py-2">Current Price</th>
                <th class="px-4 py-2">1-Year Return %</th>
              </tr>
            </thead>
            <tbody>
              {% for stock in nifty_200 %}
                <tr class="
                  {% if stock.symbol in overlap_all %}bg-purple-100 font-semibold
                  {% elif stock.symbol in overlap_n200_bse %}bg-green-100
                  {% elif stock.symbol in overlap_n200_n500 %}bg-yellow-100
                  {% else %}hover:bg-gray-50{% endif %}
                ">
                  <td class="px-4 py-2">{{ stock.rank }}</td>
                  <td class="px-4 py-2">{{ stock.symbol }}</td>
                  <td class="px-4 py-2">‚Çπ{{ stock.start_price }}</td>
                  <td class="px-4 py-2">‚Çπ{{ stock.end_price }}</td>
                  <td class="px-4 py-2">{{ stock.return_pct }}%</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- BSE 200 -->
      <div>
        <h2 class="text-xl font-semibold mb-4 text-blue-700">BSE 200 (Top 20)</h2>
        <div class="overflow-x-auto rounded shadow">
          <table class="min-w-full bg-white border border-gray-300">
            <thead class="bg-blue-100 text-blue-900">
              <tr>
                <th class="px-4 py-2">#</th>
                <th class="px-4 py-2">Stock</th>
                <th class="px-4 py-2">Start Price</th>
                <th class="px-4 py-2">Current Price</th>
                <th class="px-4 py-2">1-Year Return %</th>
              </tr>
            </thead>
            <tbody>
              {% for stock in bse_200 %}
                <tr class="
                  {% if stock.symbol in overlap_all %}bg-purple-100 font-semibold
                  {% elif stock.symbol in overlap_n200_bse %}bg-green-100
                  {% elif stock.symbol in overlap_bse_n500 %}bg-pink-100
                  {% else %}hover:bg-gray-50{% endif %}
                ">
                  <td class="px-4 py-2">{{ stock.rank }}</td>
                  <td class="px-4 py-2">{{ stock.symbol }}</td>
                  <td class="px-4 py-2">‚Çπ{{ stock.start_price }}</td>
                  <td class="px-4 py-2">‚Çπ{{ stock.end_price }}</td>
                  <td class="px-4 py-2">{{ stock.return_pct }}%</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Nifty 500 -->
         <!-- Nifty 500 -->
    <div class="mt-12">
      <h2 class="text-xl font-semibold mb-4 text-blue-700">Nifty 500 (Top 20)</h2>
      <div class="overflow-x-auto rounded shadow">
        <table class="min-w-full bg-white border border-gray-300">
          <thead class="bg-blue-100 text-blue-900">
            <tr>
              <th class="px-4 py-2">#</th>
              <th class="px-4 py-2">Stock</th>
              <th class="px-4 py-2">Start Price</th>
              <th class="px-4 py-2">Current Price</th>
              <th class="px-4 py-2">1-Year Return %</th>
            </tr>
          </thead>
          <tbody>
            {% for stock in nifty_500 %}
              <tr class="
                {% if stock.symbol in overlap_all %}bg-purple-100 font-semibold
                {% elif stock.symbol in overlap_n200_n500 %}bg-yellow-100
                {% elif stock.symbol in overlap_bse_n500 %}bg-pink-100
                {% else %}hover:bg-gray-50{% endif %}
              ">

                <td class="px-4 py-2">{{ stock.rank }}</td>
                <td class="px-4 py-2">{{ stock.symbol }}</td>
                <td class="px-4 py-2">‚Çπ{{ stock.start_price }}</td>
                <td class="px-4 py-2">‚Çπ{{ stock.end_price }}</td>
                <td class="px-4 py-2">{{ stock.return_pct }}%</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Show loading until page fully renders
  window.addEventListener("load", () => {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("tables").classList.remove("hidden");
  });
</script>
{% endblock %}
