{% extends "base_authenticated.html" %}
{% block title %}Stage 2 Delivery Screener{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">ğŸš€ Stage 2 Delivery Screener</h1>

  <form method="post" action="{{ url_for('stage2_delivery.stage2_delivery_screener_process') }}" id="screenerTriggerForm" class="mb-4">
        <!-- ğŸ” CSRF Protection -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <button type="submit" id="runScreenerButton"
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
      ğŸš€ Run Stage 2 Delivery Screener
    </button>
    <span id="screenerSpinner" class="ml-3 hidden text-green-600 animate-spin">â³</span>
  </form>

  {% if summary_message %}
    <p class="text-green-700 bg-green-100 border border-green-300 rounded px-4 py-2 mb-4">
      {{ summary_message }}
    </p>
  {% endif %}

    <form method="get" class="mb-4 flex gap-4 flex-wrap">
        <input type="text" name="symbol" placeholder="Filter by symbol" value="{{ symbol_filter }}"
                class="px-3 py-2 border rounded w-48">
        <select name="sort" class="px-3 py-2 border rounded">
            <option value="delivery_spike" {% if sort_by == 'delivery_spike' %}selected{% endif %}>Delivery Spike</option>
            <option value="volume" {% if sort_by == 'volume' %}selected{% endif %}>Volume</option>
            <option value="roc" {% if sort_by == 'roc' %}selected{% endif %}>ROC (21D)</option>
            <option value="rs" {% if sort_by == 'rs' %}selected{% endif %}>RS vs Index</option>
        </select>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">ğŸ” Apply</button>
        <a href="{{ url_for('stage2_delivery.stage2_delivery_screener_view') }}"
            class="px-4 py-2 bg-gray-300 text-black rounded">ğŸ”„ Reset</a>
    </form>

  <div class="overflow-x-auto">
    <table class="table-auto w-full border-collapse shadow-md rounded bg-white" id="sortable-table">
      <thead class="bg-gray-200 text-sm">
        <tr>
          <th class="px-4 py-2">#</th>
          <th class="px-4 py-2">Date</th>
          <th class="px-4 py-2">Symbol</th>
          <th class="px-4 py-2">Price</th>
          <th class="px-4 py-2">Volume</th>
          <th class="px-4 py-2">Delivery Spike</th>
          <th class="px-4 py-2">ROC (21D)</th>
          <th class="px-4 py-2">RS vs Index</th>
          <th class="px-4 py-2">Tag</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in stocks %}
        <tr class="border-t text-sm hover:bg-gray-50">
          <td class="px-4 py-2">{{ loop.index }}</td>
          <td class="px-4 py-2">{{ stock.date.strftime('%d-%b-%Y') }}</td>
          <td class="px-4 py-2 flex items-center gap-2">
            <span id="symbol-{{ loop.index }}">{{ stock.symbol_clean }}</span>
            <button onclick="copyToClipboard('{{ stock.symbol_clean }}')" class="text-blue-600 hover:underline text-xs">ğŸ“‹</button>
          </td>
          <td class="px-4 py-2">â‚¹{{ "%.2f"|format(stock.price) }}</td>
          <td class="px-4 py-2">{{ "{:,}".format(stock.volume) }}</td>
          <td class="px-4 py-2">{{ stock.delivery_spike }}x</td>
          <td class="px-4 py-2 {% if stock.roc_21d >= 10 %}text-green-600{% elif stock.roc_21d <= -5 %}text-red-500{% endif %}">
            {{ stock.roc_21d }}%
          </td>
          <td class="px-4 py-2 {% if stock.rs_vs_index_21d >= 5 %}text-green-600{% elif stock.rs_vs_index_21d <= -5 %}text-red-500{% endif %}">
            {{ stock.rs_vs_index_21d }}%
          </td>
          <td class="px-4 py-2">{{ stock.tag }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// function copyToClipboard(id) {
//   const el = document.getElementById(id);
//   if (el) {
//     navigator.clipboard.writeText(el.textContent).then(() => {
//       alert(`Copied: ${el.textContent}`);
//     });
//   }
// }

document.getElementById("screenerTriggerForm")?.addEventListener("submit", function(e) {
  const btn = document.getElementById("runScreenerButton");
  const spinner = document.getElementById("screenerSpinner");

  btn.disabled = true;
  btn.textContent = "Processing...";
  spinner.classList.remove("hidden");
});

window.addEventListener("load", function() {
  const message = document.querySelector("[data-summary-message]")?.textContent;
  if (message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
});


</script>
{% endblock %}
